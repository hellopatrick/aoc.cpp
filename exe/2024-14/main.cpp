#include "coord.h"
#include "lib.h"
#include "scn/scan.h"

#include <chrono>
#include <cstdint>
#include <iostream>
#include <print>
#include <unordered_set>
#include <vector>

struct Robot {
    int64_t px, py;
    int64_t vx, vy;
};

using Puzzle = std::vector<Robot>;

Puzzle parse_stdin() {
    Puzzle p;

    auto lines = aoc::readlines();

    for (auto &l : lines) {
        if (auto result = scn::scan<int64_t, int64_t, int64_t, int64_t>(
                l, "p={},{} v={},{}")) {
            auto [px, py, vx, vy] = result->values();

            p.emplace_back(px, py, vx, vy);
        }
    }

    return p;
}

int64_t wrap(int64_t p, int64_t c) {
    if (p < 0) {
        return c + p;
    } else if (p >= c) {
        return p % c;
    }

    return p;
}

using set = std::unordered_set<aoc::Coord, aoc::CoordHasher>;

void draw(std::vector<Robot> &robots, int w, int h) {
    for (int y = 0; y < h; y++) {
        for (int x = 0; x < w; x++) {
            auto count = 0;
            for (auto &r : robots) {
                count += (r.px == x && r.py == y);
            }

            if (count == 0) {
                std::cout << '.';
            } else {
                std::cout << count;
            }
        }
        std::cout << std::endl;
    }

    for (int x = 0; x < w; x++) {
        std::cout << '=';
    }
    std::cout << std::endl;
}

int main() {
    auto data = parse_stdin();

    int64_t w = 101;
    int64_t h = 103;

    int i = 0;

    for (; i < 100; i++) {
        for (auto &r : data) {
            r.px = wrap(r.px + r.vx, w);
            r.py = wrap(r.py + r.vy, h);
        }
    }

    auto qx = w / 2;
    auto qy = h / 2;

    int64_t q1 = 0;
    int64_t q2 = 0;
    int64_t q3 = 0;
    int64_t q4 = 0;

    for (auto &r : data) {
        auto le = r.px < qx;
        auto ri = r.px > qx;
        auto up = r.py < qy;
        auto bo = r.py > qy;

        if (le && up) {
            q1++;
        }

        if (le && bo) {
            q2++;
        }

        if (ri && up) {
            q3++;
        }

        if (ri && bo) {
            q4++;
        }
    }

    auto start = std::chrono::high_resolution_clock::now();

    auto part1 = q1 * q2 * q3 * q4;

    while (true) {
        for (auto &r : data) {
            r.px = wrap(r.px + r.vx, w);
            r.py = wrap(r.py + r.vy, h);
        }

        i++;

        auto uniq = set();
        auto found = true;

        for (auto &robot : data) {
            if (uniq.contains({robot.px, robot.py})) {
                found = false;
                break;
            }

            uniq.emplace(robot.px, robot.py);
        }

        if (found) {
            break;
        }
    }

    auto part2 = i;

    draw(data, w, h);

    auto end = std::chrono::high_resolution_clock::now();
    auto dur =
        std::chrono::duration_cast<std::chrono::microseconds>(end - start);

    std::print("part 1: {}\n", part1);
    std::print("part 2: {}\n", part2);
    std::print("dur:    {}us\n", dur.count());
}

// ...............1.....1...............1.........................................1.....................
// .........................1....................................1.................................1....
// ...................................................................1.................................
// .......................................1.............................................................
// ...................................................................................................1.
// ..................1..................................................................................
// .........................1...........................................................................
// .....................................................................................................
// .....................................................................................................
// ...........................................1..............1..........................................
// ..............................1....................................................................1.
// .................1...................................................................................
// .....................................................................................................
// .....................................................................................................
// ............................................................................1........................
// .....................................................................................................
// .....................................................................................................
// .........................................1........1.................................................1
// ...........................1...1...............................................1.....................
// .....................................................................................................
// ..........1..........................................................................................
// .......................1......1...................1..................................................
// ...................................................................................1....1............
// ...............................1..1..................................................................
// .....................................................................................................
// ........1..............1111111111111111111111111111111...............................................
// .................1.....1.............................1...............................................
// .......................1.............................1..................................1............
// ...................1...1.............................1...............................................
// .......................1.............................1...............................................
// .......................1..............1..............1.........1.....................................
// .......................1.............111.............1...............................................
// ...1...................1............11111............1.1.............................................
// .......................1...........1111111...........1...............................................
// .......................1..........111111111..........1..........................1....................
// .......................1............11111............1..................1............................
// ..1......1...1.........1...........1111111...........1..............1........................1.1.....
// .......................1..........111111111..........1...............................................
// .......................1.........11111111111.........1...............................................
// .......................1........1111111111111........1...............................................
// .......................1..........111111111..........1...............................................
// .....1.................1.........11111111111.........1...............................................
// .......................1........1111111111111........1......................................1........
// .......................1.......111111111111111.......1...............................................
// ...........1...........1......11111111111111111......1...............................................
// .......................1........1111111111111........1...............................1.....1.........
// ................1.1....1.......111111111111111.......1..............................1................
// .......1...............1......11111111111111111......1...............................................
// .............1.........1.....1111111111111111111.....1...............................................
// ......1..1.............1....111111111111111111111....1..................................1....1.......
// .......................1.............111.............1...................1.................1.......1.
// .......................1.............111.............1...............................................
// .......................1.............111.............1.......................1..............1........
// .......................1.............................1...............................1...............
// .......................1.............................1........................1......................
// .......................1.............................1.....1.........................................
// .......................1.............................1...............................................
// .......................1111111111111111111111111111111...............................................
// .....................................................................................................
// ...................1..1..............................................................................
// ..............................1..1...................................................................
// ..................................................1..................................................
// .......1..1.............1..1.........................................................................
// .................1......1............1.................1......1....................1.................
// .....................................................................................................
// ......................................1..............................................................
// .....................................................................................................
// 1....................................................................................................
// ...1.............................................................1...................................
// ............................1........................................................................
// .............................................1.........................................1.............
// ..................................................1......1...........................................
// .............................................................................................1..1....
// ...............................................................1......................1..............
// ....................................................1................................................
// ...................................................................................................1.
// .......................................1...........................1................1.............1..
// ...................................................1.................................................
// .....................................................................................................
// ...........................................................1...................................1.....
// ...........1................................1...............................1........................
// ........1........................1.......1...........................................................
// .............................1........................................................1............1.
// ............................1........................................................................
// .....................................................................................................
// ......................................................1.....1........................................
// .....................................................................................................
// ..........1.....................................................................1........1..........1
// ............................................................1........................................
// .........1...............................1...........................................................
// .....................................................................................................
// .1............................................11.................1...1.1.....................1.......
// .....................................................................................................
// ........1...........................................................1................................
// .........................................................1...........................1...............
// .............................................................1.......................................
// .............................1....1.1.....................1..........................................
// ...................................................................................1.................
// .....................................................................................................
// ..................................................................................1..................
// ........................................................................................1............
// ..............................................................1......................................
// ...1..............1..................................................................................
